@page "/admin/appeals"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize(Roles = "Administrator")]
@inject IAppealClosingDateService ClosingDateService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Manage Appeals</PageTitle>

<div class="container">
    <h1>Appeal Settings</h1>
    
    @if (_loading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-header">
                <h2>Appeal Closing Date</h2>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label>Current Status:</label>
                    <div class="alert @(_isAppealPeriodOpen ? "alert-success" : "alert-warning")">
                        @if (_isAppealPeriodOpen)
                        {
                            @if (_closingDate.HasValue)
                            {
                                <span>Appeal submission is open until @_closingDate.Value.ToString("MMMM dd, yyyy").</span>
                            }
                            else
                            {
                                <span>Appeal submission is open indefinitely (no closing date set).</span>
                            }
                        }
                        else
                        {
                            <span>Appeal submission is closed since @_closingDate?.ToString("MMMM dd, yyyy").</span>
                        }
                    </div>
                </div>
                
                <EditForm Model="@_closingDateModel" OnValidSubmit="@SaveClosingDate">
                    <DataAnnotationsValidator />
                    
                    <div class="form-group">
                        <label>Set Closing Date:</label>
                        <InputDate @bind-Value="_closingDateModel.ClosingDate" class="form-control" />
                        <ValidationMessage For="@(() => _closingDateModel.ClosingDate)" />
                    </div>
                    
                    <div class="form-check mt-3">
                        <InputCheckbox @bind-Value="_closingDateModel.RemoveClosingDate" id="removeDate" class="form-check-input" />
                        <label for="removeDate" class="form-check-label">Remove closing date (keep appeals open indefinitely)</label>
                    </div>
                    
                    <div class="form-actions mt-3">
                        <button type="submit" class="btn btn-primary" disabled="@_saving">
                            @if (_saving)
                            {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>Save Changes</span>
                            }
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
        
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger mt-3">
                @_errorMessage
            </div>
        }
    }
</div>

@code {
    private bool _loading = true;
    private bool _saving = false;
    private bool _isAppealPeriodOpen;
    private DateTime? _closingDate;
    private ClosingDateModel _closingDateModel = new();
    private string _errorMessage;
    private string _currentUser;
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get current user
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            _currentUser = user.Identity.Name;
            
            _isAppealPeriodOpen = await ClosingDateService.IsAppealPeriodOpenAsync();
            _closingDate = await ClosingDateService.GetClosingDateAsync();
            
            if (_closingDate.HasValue)
            {
                _closingDateModel.ClosingDate = _closingDate.Value;
            }
            else
            {
                // Default to tomorrow
                _closingDateModel.ClosingDate = DateTime.Now.AddDays(1);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading data: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }
    
    private async Task SaveClosingDate()
    {
        try
        {
            _saving = true;
            _errorMessage = string.Empty;
            
            if (_closingDateModel.RemoveClosingDate)
            {
                await ClosingDateService.RemoveClosingDateAsync(_currentUser);
                _closingDate = null;
                _isAppealPeriodOpen = true;
            }
            else
            {
                await ClosingDateService.SetClosingDateAsync(_closingDateModel.ClosingDate, _currentUser);
                _closingDate = _closingDateModel.ClosingDate;
                _isAppealPeriodOpen = DateTime.Now < _closingDateModel.ClosingDate;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error saving changes: {ex.Message}";
        }
        finally
        {
            _saving = false;
        }
    }
    
    private class ClosingDateModel
    {
        [Required(ErrorMessage = "Closing date is required.")]
        public DateTime ClosingDate { get; set; }
        
        public bool RemoveClosingDate { get; set; }
    }
}
