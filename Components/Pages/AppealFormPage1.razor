@page "/appeal"
@inject IAppealFormService FormService
@inject NavigationManager Navigation


<PageTitle>Appeal Form</PageTitle>

<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="AppealFormPage1.css"/>
    <script src="AppealFormPage1.js"></script>
</head>
<body>
<div class="container">
    <header>
        <button id="toggle-button" class="lang-toggle" onclick="toggleLanguage()">Español</button>
    </header>
    <main>
        <EditForm Model="@FormService.CurrentForm" FormName="AppealForm1" OnSubmit="@HandleValidSubmit">
            <DataAnnotationsValidator/>

            <section id="student-info" class="card">
                <h2 id="student-info-heading">Student Information</h2>
                <div class="form-group">
                    <label id="label-name">
                        <span class="label-text">Name:</span>
                        <InputText @bind-Value="FormService.CurrentForm.Name" class="form-control" placeholder="Your name..."/>
                        <ValidationMessage For="@(() => FormService.CurrentForm.Name)"/>
                    </label>
                </div>

                <div class="form-group">
                    <label id="label-student-id">
                        <span class="label-text">Student ID#:</span>
                        <InputText @bind-Value="FormService.CurrentForm.StudentId" class="form-control" placeholder="ex: p000..."/>
                        <ValidationMessage For="@(() => FormService.CurrentForm.StudentId)"/>
                    </label>
                </div>

                <div class="form-group">
                    <label id="label-date">
                        <span class="label-text">Date:</span>
                        <InputDate @bind-Value="FormService.CurrentForm.Date" class="form-control"/>
                        <ValidationMessage For="@(() => FormService.CurrentForm.Date)"/>
                    </label>
                </div>

                <div class="form-group">
                    <label id="email-name">
                        <span class="label-text">Email:</span>
                        <InputText @bind-Value="FormService.CurrentForm.Email" class="form-control" placeholder="Your email..."/>
                        <ValidationMessage For="@(() => FormService.CurrentForm.Email)"/>
                    </label>
                </div>

                <div class="form-group">
                    <label id="label-major">
                        <span class="label-text">Major:</span>
                        <InputText @bind-Value="FormService.CurrentForm.Major" class="form-control" placeholder="Your major..."/>
                        <ValidationMessage For="@(() => FormService.CurrentForm.Major)"/>
                    </label>
                </div>
            </section>

            <section id="appeal-details" class="card">
                <h2 id="appeal-details-heading">Appeal Explanation</h2>
                <p id="appeal-details-text">
                    Please provide a signed, typed, or written statement (max 500 words) explaining:
                </p>
                <ol id="appeal-details-list">
                    <li id="appeal-list-1">Any extenuating circumstances that led to your SAP status.</li>
                    <li id="appeal-list-2">How these circumstances affected your academic progress.</li>
                    <li id="appeal-list-3">Steps you have taken to overcome them.</li>
                    <li id="appeal-list-4">Your plan for future academic success.</li>
                </ol>
                <div class="form-group">
                    <InputTextArea @bind-Value="FormService.CurrentForm.AppealExplanation"
                                  class="form-control"
                                  id="text-area"
                                  rows="6"
                                  placeholder="Write your explanation here..."
                                  @onkeyup="UpdateWordCount" />
                    <div class="word-count @(isOverLimit ? "text-danger" : "text-muted")">
                        @wordCountMessage
                    </div>
                    <ValidationMessage For="@(() => FormService.CurrentForm.AppealExplanation)"/>
                </div>
            </section>

            <section class="card" id="acknowledgements-section">
                <h2 id="acknowledgements-heading">Acknowledgements</h2>
                <div class="checkbox-container">
                    <InputCheckbox @bind-Value="FormService.CurrentForm.AcknowledgementPayment" id="checkbox1" />
                    <span id="checkbox1-text">
                        Payment arrangement: I understand the Office of Financial Aid will NOT hold my classes pending a decision by the SAP committee if I am unable to pay any balance on the account.
                    </span>
                    <ValidationMessage For="@(() => FormService.CurrentForm.AcknowledgementPayment)"/>
                </div>
                
                <div class="checkbox-container">
                    <InputCheckbox @bind-Value="FormService.CurrentForm.AcknowledgementFinal" id="checkbox2" />
                    <span id="checkbox2-text">
                        I understand that the decision of the Office of Financial Aid is final.
                    </span>
                    <ValidationMessage For="@(() => FormService.CurrentForm.AcknowledgementFinal)"/>
                </div>
            </section>
            
            <div class="form-actions mt-3">
                <button type="submit" id="submit-button" class="btn btn-primary">Next</button>
            </div>
        </EditForm>
    </main>
</div>
</body>
</html>

@code {
    private string wordCountMessage = "0/500 words";
    private bool isOverLimit = false;
    
    private void UpdateWordCount(KeyboardEventArgs e)
    {
        if (FormService.CurrentForm.AppealExplanation != null)
        {
            string text = FormService.CurrentForm.AppealExplanation.Trim();
            int wordCount = text.Split(new[] { ' ', '\t', '\n' }, StringSplitOptions.RemoveEmptyEntries).Length;
            isOverLimit = wordCount > 500;
            wordCountMessage = $"{wordCount}/500 words";
        }
        else
        {
            wordCountMessage = "0/500 words";
            isOverLimit = false;
        }
    }
    
    private void HandleValidSubmit()
    {
        // Simply navigate to the next page since form is already bound to FormService.CurrentForm
        Navigation.NavigateTo("/appeal2");
    }
}